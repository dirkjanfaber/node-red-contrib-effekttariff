<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Effekttariff Simulation Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { color: #333; margin-bottom: 5px; }
    .subtitle { color: #666; margin-bottom: 20px; }
    .meta {
      background: #fff;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .meta-item { }
    .meta-label { font-size: 12px; color: #888; text-transform: uppercase; }
    .meta-value { font-size: 18px; font-weight: 600; color: #333; }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
      gap: 20px;
    }
    .chart-container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .chart-title { margin: 0 0 15px 0; color: #333; font-size: 16px; }
    canvas { max-height: 300px; }
    .summary {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .summary h3 { margin-top: 0; }
    .peaks-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .peaks-table th, .peaks-table td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .peaks-table th { background: #f9f9f9; font-weight: 600; }
    .verification {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
    }
    .verification.passed { background: #d4edda; }
    .verification.failed { background: #f8d7da; }
    .analysis {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    .analysis h2 { margin: 0 0 20px 0; font-size: 20px; }
    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      text-align: center;
    }
    .analysis-item { }
    .analysis-label { font-size: 12px; opacity: 0.9; text-transform: uppercase; margin-bottom: 5px; }
    .analysis-value { font-size: 28px; font-weight: 700; }
    .analysis-subtext { font-size: 12px; opacity: 0.8; margin-top: 3px; }
    .reduction { color: #4ade80; }
    .analysis-explanation {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.2);
      font-size: 14px;
      line-height: 1.6;
    }
    .analysis-explanation strong { color: #fbbf24; }
    .comparison-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    .comparison-table th, .comparison-table td {
      padding: 12px 15px;
      text-align: left;
    }
    .comparison-table th {
      background: rgba(255,255,255,0.15);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
    }
    .comparison-table td { border-top: 1px solid rgba(255,255,255,0.1); }
    @media (max-width: 768px) {
      .analysis-grid { grid-template-columns: 1fr; }
    }
    .report-footer {
      margin-top: 30px;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
      color: #666;
      font-size: 0.9em;
    }
    .report-footer a { color: #0066cc; text-decoration: none; }
    .report-footer a:hover { text-decoration: underline; }
    .footer-links { margin-top: 10px; }
    .footer-links a { margin: 0 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Effekttariff Simulation Report</h1>
    <p class="subtitle">Downtime Detection - Tests the downtime detection feature with a simulated data gap.</p>

    <div class="meta">
      <div class="meta-grid">
        <div class="meta-item">
          <div class="meta-label">Period</div>
          <div class="meta-value">2024-03-01 to 2024-03-04</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">Duration</div>
          <div class="meta-value">3 days</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">Peak Count</div>
          <div class="meta-value">3</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">Peak Hours</div>
          <div class="meta-value">7:00 - 21:00</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">Average Power</div>
          <div class="meta-value">1.86 kW</div>
        </div>
        <div class="meta-item">
          <div class="meta-label">Peak Average</div>
          <div class="meta-value">4 kW</div>
        </div>
      </div>
    </div>
    

    <div class="analysis">
      <h2>Analysis: What Does This Simulation Prove?</h2>
      <div class="analysis-explanation"><strong>What this proves:</strong> Real systems experience outages - Node-RED restarts, network issues,
      sensor failures. During downtime, the system can't track peaks, which could lead to unexpected high bills.
      This simulation includes a 5-hour data gap on day 2 (05:00-10:00 with 0W readings) to test downtime detection.
      When configured, the system logs warnings about missing data periods, alerting you to potential blind spots
      in peak tracking. This awareness helps you take corrective action if needed.</div>
      
      <div class="analysis-grid">
        <div class="analysis-item">
          <div class="analysis-label">Detected Peak Average</div>
          <div class="analysis-value">4 kW</div>
          <div class="analysis-subtext">Top 3 peaks averaged</div>
        </div>
        <div class="analysis-item">
          <div class="analysis-label">Highest Peak</div>
          <div class="analysis-value">4.00 kW</div>
          <div class="analysis-subtext">Maximum recorded</div>
        </div>
        <div class="analysis-item">
          <div class="analysis-label">Est. Monthly Cost*</div>
          <div class="analysis-value">200 SEK</div>
          <div class="analysis-subtext">Effektavgift portion</div>
        </div>
      </div>
      <div class="analysis-explanation">
        <strong>Why No Savings?</strong> This simulation has no battery configured. The effekttariff node outputs a
        current limit signal, but without a battery to discharge, there's nothing to cover the difference when
        consumption exceeds the limit. The grid must supply all power, so peaks cannot be reduced.
        <br/><br/>
        <strong>What This Shows:</strong> The system correctly tracks your top 3 peaks during
        peak hours and calculates your effektavgift at approximately <strong>200 SEK/month</strong>.
        This monitoring alone is valuable for understanding your consumption patterns.
        <br/><br/>
        <strong>To Actually Reduce Peaks:</strong> You need a battery that can discharge during high-consumption moments.
        The node tells your ESS "limit grid to X amps" - the battery covers the rest. See the <code>batteryCharging</code>
        scenario for a 40-50% reduction example, potentially saving
        <strong>80-100 SEK/month</strong>.
      </div>
      <table class="comparison-table">
        <thead>
          <tr>
            <th>Peak #</th>
            <th>Date</th>
            <th>Hour</th>
            <th>Power (kW)</th>
          </tr>
        </thead>
        <tbody>
          
          <tr>
            <td>1</td>
            <td>2024-03-01</td>
            <td>17:00</td>
            <td>4.00</td>
          </tr>
          
          <tr>
            <td>2</td>
            <td>2024-03-02</td>
            <td>17:00</td>
            <td>4.00</td>
          </tr>
          
          <tr>
            <td>3</td>
            <td>2024-03-03</td>
            <td>17:00</td>
            <td>4.00</td>
          </tr>
          
        </tbody>
      </table>
      
      <div style="font-size: 11px; opacity: 0.7; margin-top: 10px;">*Estimated using typical Swedish effekttariff rate of ~50 SEK/kW/month. Actual rates vary by provider.</div>
    </div>

    <div class="charts-grid">
      <div class="chart-container">
        <h3 class="chart-title">Hourly Power Consumption vs Limit</h3>
        <canvas id="powerChart"></canvas>
      </div>

      <div class="chart-container">
        <h3 class="chart-title">Top 3 Recorded Peaks</h3>
        <canvas id="peaksChart"></canvas>
      </div>

      
    </div>

    <div class="summary">
      <h3>Top Peaks</h3>
      <table class="peaks-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Date</th>
            <th>Hour</th>
            <th>Actual (kW)</th>
            <th>Effective (kW)</th>
          </tr>
        </thead>
        <tbody>
          
          <tr>
            <td>1</td>
            <td>2024-03-01</td>
            <td>17:00</td>
            <td>4.00</td>
            <td>4.00</td>
          </tr>
          
          <tr>
            <td>2</td>
            <td>2024-03-02</td>
            <td>17:00</td>
            <td>4.00</td>
            <td>4.00</td>
          </tr>
          
          <tr>
            <td>3</td>
            <td>2024-03-03</td>
            <td>17:00</td>
            <td>4.00</td>
            <td>4.00</td>
          </tr>
          
        </tbody>
      </table>
    </div>

    
    <div class="verification passed">
      <strong>Verification: ✓ PASSED</strong>
      (1/1 checks)
    </div>
    
  </div>

  <script>
    // Power consumption chart
    new Chart(document.getElementById('powerChart'), {
      type: 'line',
      data: {
        labels: ["2024-03-01T00:00:00.000Z","2024-03-01T01:00:00.000Z","2024-03-01T02:00:00.000Z","2024-03-01T03:00:00.000Z","2024-03-01T04:00:00.000Z","2024-03-01T05:00:00.000Z","2024-03-01T06:00:00.000Z","2024-03-01T07:00:00.000Z","2024-03-01T08:00:00.000Z","2024-03-01T09:00:00.000Z","2024-03-01T10:00:00.000Z","2024-03-01T11:00:00.000Z","2024-03-01T12:00:00.000Z","2024-03-01T13:00:00.000Z","2024-03-01T14:00:00.000Z","2024-03-01T15:00:00.000Z","2024-03-01T16:00:00.000Z","2024-03-01T17:00:00.000Z","2024-03-01T18:00:00.000Z","2024-03-01T19:00:00.000Z","2024-03-01T20:00:00.000Z","2024-03-01T21:00:00.000Z","2024-03-01T22:00:00.000Z","2024-03-01T23:00:00.000Z","2024-03-02T00:00:00.000Z","2024-03-02T01:00:00.000Z","2024-03-02T02:00:00.000Z","2024-03-02T03:00:00.000Z","2024-03-02T04:00:00.000Z","2024-03-02T05:00:00.000Z","2024-03-02T06:00:00.000Z","2024-03-02T07:00:00.000Z","2024-03-02T08:00:00.000Z","2024-03-02T09:00:00.000Z","2024-03-02T10:00:00.000Z","2024-03-02T11:00:00.000Z","2024-03-02T12:00:00.000Z","2024-03-02T13:00:00.000Z","2024-03-02T14:00:00.000Z","2024-03-02T15:00:00.000Z","2024-03-02T16:00:00.000Z","2024-03-02T17:00:00.000Z","2024-03-02T18:00:00.000Z","2024-03-02T19:00:00.000Z","2024-03-02T20:00:00.000Z","2024-03-02T21:00:00.000Z","2024-03-02T22:00:00.000Z","2024-03-02T23:00:00.000Z","2024-03-03T00:00:00.000Z","2024-03-03T01:00:00.000Z","2024-03-03T02:00:00.000Z","2024-03-03T03:00:00.000Z","2024-03-03T04:00:00.000Z","2024-03-03T05:00:00.000Z","2024-03-03T06:00:00.000Z","2024-03-03T07:00:00.000Z","2024-03-03T08:00:00.000Z","2024-03-03T09:00:00.000Z","2024-03-03T10:00:00.000Z","2024-03-03T11:00:00.000Z","2024-03-03T12:00:00.000Z","2024-03-03T13:00:00.000Z","2024-03-03T14:00:00.000Z","2024-03-03T15:00:00.000Z","2024-03-03T16:00:00.000Z","2024-03-03T17:00:00.000Z","2024-03-03T18:00:00.000Z","2024-03-03T19:00:00.000Z","2024-03-03T20:00:00.000Z","2024-03-03T21:00:00.000Z","2024-03-03T22:00:00.000Z"],
        datasets: [
          {
            label: 'Consumption (W)',
            data: [1000,1000,1000,1000,1000,1000,3400,3400,3400,1600,1600,1600,1600,1600,1600,1600,1600,4000,4000,4000,4000,1200,1200,1200,1000,1000,1000,1000,1000,0,0,0,0,0,1600,1600,1600,1600,1600,1600,1600,4000,4000,4000,4000,1200,1200,1200,1000,1000,1000,1000,1000,1000,3400,3400,3400,1600,1600,1600,1600,1600,1600,1600,1600,4000,4000,4000,4000,1200,1200],
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 0
          },
          {
            label: 'Effective (W)',
            data: [1000,1000,1000,1000,1000,1000,3400,3400,3400,1600,1600,1600,1600,1600,1600,1600,1600,4000,4000,4000,4000,1200,1200,1200,1000,1000,1000,1000,1000,0,0,0,0,0,1600,1600,1600,1600,1600,1600,1600,4000,4000,4000,4000,1200,1200,1200,1000,1000,1000,1000,1000,1000,3400,3400,3400,1600,1600,1600,1600,1600,1600,1600,1600,4000,4000,4000,4000,1200,1200],
            borderColor: '#10b981',
            backgroundColor: 'transparent',
            borderDash: [5, 5],
            tension: 0.3,
            pointRadius: 0
          },
          {
            label: 'Limit (W)',
            data: [{"x":"2024-03-01T00:00:00.000Z","y":17250},{"x":"2024-03-01T01:00:00.000Z","y":17250},{"x":"2024-03-01T02:00:00.000Z","y":17250},{"x":"2024-03-01T03:00:00.000Z","y":17250},{"x":"2024-03-01T04:00:00.000Z","y":17250},{"x":"2024-03-01T05:00:00.000Z","y":17250},{"x":"2024-03-01T06:00:00.000Z","y":17250},{"x":"2024-03-01T07:00:00.000Z","y":4002},{"x":"2024-03-01T08:00:00.000Z","y":4002},{"x":"2024-03-01T09:00:00.000Z","y":4002},{"x":"2024-03-01T10:00:00.000Z","y":4002},{"x":"2024-03-01T11:00:00.000Z","y":4002},{"x":"2024-03-01T12:00:00.000Z","y":4002},{"x":"2024-03-01T13:00:00.000Z","y":4002},{"x":"2024-03-01T14:00:00.000Z","y":4002},{"x":"2024-03-01T15:00:00.000Z","y":4002},{"x":"2024-03-01T16:00:00.000Z","y":4002},{"x":"2024-03-01T17:00:00.000Z","y":4002},{"x":"2024-03-01T18:00:00.000Z","y":4002},{"x":"2024-03-01T19:00:00.000Z","y":4002},{"x":"2024-03-01T20:00:00.000Z","y":4002},{"x":"2024-03-01T21:00:00.000Z","y":17250},{"x":"2024-03-01T22:00:00.000Z","y":17250},{"x":"2024-03-01T23:00:00.000Z","y":17250},{"x":"2024-03-02T00:00:00.000Z","y":17250},{"x":"2024-03-02T01:00:00.000Z","y":17250},{"x":"2024-03-02T02:00:00.000Z","y":17250},{"x":"2024-03-02T03:00:00.000Z","y":17250},{"x":"2024-03-02T04:00:00.000Z","y":17250},{"x":"2024-03-02T05:00:00.000Z","y":17250},{"x":"2024-03-02T06:00:00.000Z","y":17250},{"x":"2024-03-02T07:00:00.000Z","y":4002},{"x":"2024-03-02T08:00:00.000Z","y":4002},{"x":"2024-03-02T09:00:00.000Z","y":4002},{"x":"2024-03-02T10:00:00.000Z","y":4002},{"x":"2024-03-02T11:00:00.000Z","y":4002},{"x":"2024-03-02T12:00:00.000Z","y":4002},{"x":"2024-03-02T13:00:00.000Z","y":4002},{"x":"2024-03-02T14:00:00.000Z","y":4002},{"x":"2024-03-02T15:00:00.000Z","y":4002},{"x":"2024-03-02T16:00:00.000Z","y":4002},{"x":"2024-03-02T17:00:00.000Z","y":4002},{"x":"2024-03-02T18:00:00.000Z","y":4002},{"x":"2024-03-02T19:00:00.000Z","y":4002},{"x":"2024-03-02T20:00:00.000Z","y":4002},{"x":"2024-03-02T21:00:00.000Z","y":17250},{"x":"2024-03-02T22:00:00.000Z","y":17250},{"x":"2024-03-02T23:00:00.000Z","y":17250},{"x":"2024-03-03T00:00:00.000Z","y":17250},{"x":"2024-03-03T01:00:00.000Z","y":17250},{"x":"2024-03-03T02:00:00.000Z","y":17250},{"x":"2024-03-03T03:00:00.000Z","y":17250},{"x":"2024-03-03T04:00:00.000Z","y":17250},{"x":"2024-03-03T05:00:00.000Z","y":17250},{"x":"2024-03-03T06:00:00.000Z","y":17250},{"x":"2024-03-03T07:00:00.000Z","y":4002},{"x":"2024-03-03T08:00:00.000Z","y":4002},{"x":"2024-03-03T09:00:00.000Z","y":4002},{"x":"2024-03-03T10:00:00.000Z","y":4002},{"x":"2024-03-03T11:00:00.000Z","y":4002},{"x":"2024-03-03T12:00:00.000Z","y":4002},{"x":"2024-03-03T13:00:00.000Z","y":4002},{"x":"2024-03-03T14:00:00.000Z","y":4002},{"x":"2024-03-03T15:00:00.000Z","y":4002},{"x":"2024-03-03T16:00:00.000Z","y":4002},{"x":"2024-03-03T17:00:00.000Z","y":4002},{"x":"2024-03-03T18:00:00.000Z","y":4002},{"x":"2024-03-03T19:00:00.000Z","y":4002},{"x":"2024-03-03T20:00:00.000Z","y":4002},{"x":"2024-03-03T21:00:00.000Z","y":17250},{"x":"2024-03-03T22:00:00.000Z","y":17250}],
            borderColor: '#ef4444',
            backgroundColor: 'transparent',
            borderWidth: 2,
            stepped: true,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        interaction: { intersect: false, mode: 'index' },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'day' },
            title: { display: true, text: 'Date' }
          },
          y: {
            title: { display: true, text: 'Power (W)' },
            beginAtZero: true
          }
        },
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                return ctx.dataset.label + ': ' + (ctx.parsed.y / 1000).toFixed(2) + ' kW';
              }
            }
          }
        }
      }
    });

    // Peaks bar chart
    new Chart(document.getElementById('peaksChart'), {
      type: 'bar',
      data: {
        labels: ["2024-03-01 17:00","2024-03-02 17:00","2024-03-03 17:00"],
        datasets: [{
          label: 'Effective Power (W)',
          data: [4000,4000,4000],
          backgroundColor: '#f59e0b',
          borderColor: '#d97706',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        indexAxis: 'y',
        scales: {
          x: {
            title: { display: true, text: 'Power (W)' },
            beginAtZero: true
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(ctx) {
                return (ctx.parsed.x / 1000).toFixed(2) + ' kW';
              }
            }
          }
        }
      }
    });

    
  </script>

  <div class="report-footer">
    <div>Generated by <a href="https://github.com/dirkjanfaber/node-red-contrib-effekttariff">node-red-contrib-effekttariff</a></div>
    <div class="footer-links">
      <a href="index.html">← All Simulations</a>
      <a href="https://github.com/dirkjanfaber/node-red-contrib-effekttariff">GitHub Repository</a>
    </div>
  </div>
</body>
</html>