name: Generate Simulation Reports

on:
  push:
    branches: [ main ]
    paths:
      - 'lib/**'
      - 'scripts/**'
      - 'package.json'
  workflow_dispatch:  # Allow manual trigger

jobs:
  generate-reports:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x

    - name: Install dependencies
      run: npm ci

    - name: Run tests first
      run: npm test

    - name: Create output directory
      run: mkdir -p docs/simulations

    - name: Generate simulation reports
      run: |
        # Run each scenario and generate HTML report
        scenarios=(
          "basicWeek"
          "fullMonth"
          "highSpikes"
          "nightDiscount"
          "weekdaysOnly"
          "winterSeason"
          "singlePhase"
          "minimumLimit"
          "jonkoping"
          "stressTest"
          "batteryCharging"
          "batteryBalancing"
          "dynamicHeadroom"
          "downtimeDetection"
        )

        for scenario in "${scenarios[@]}"; do
          echo "Running scenario: $scenario"
          node scripts/run-simulation.js "$scenario" --html --no-timestamp --no-open || true
        done

        # Move generated files to docs/simulations
        if [ -d "simulation-output" ]; then
          mv simulation-output/*.html docs/simulations/ 2>/dev/null || true
        fi

    - name: Generate index page
      run: |
        cat > docs/simulations/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Effekttariff Simulation Reports</title>
          <style>
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              max-width: 800px;
              margin: 0 auto;
              padding: 20px;
              background: #f5f5f5;
            }
            h1 { color: #333; }
            .scenario-list {
              list-style: none;
              padding: 0;
            }
            .scenario-list li {
              background: white;
              margin: 10px 0;
              padding: 15px 20px;
              border-radius: 8px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .scenario-list a {
              color: #0066cc;
              text-decoration: none;
              font-weight: 500;
            }
            .scenario-list a:hover {
              text-decoration: underline;
            }
            .description {
              color: #666;
              font-size: 0.9em;
              margin-top: 5px;
            }
            .meta {
              color: #999;
              font-size: 0.8em;
              margin-top: 20px;
            }
          </style>
        </head>
        <body>
          <h1>ðŸ”Œ Effekttariff Simulation Reports</h1>
          <p>Interactive simulation reports for the Swedish effekttariff peak shaving system.</p>

          <h2>Available Scenarios</h2>
          <ul class="scenario-list">
            <li>
              <a href="basicWeek.html">Basic Week</a>
              <div class="description">One week of typical Swedish household consumption (7 days)</div>
            </li>
            <li>
              <a href="fullMonth.html">Full Month Cycle</a>
              <div class="description">Complete month to verify peak reset behavior (35 days)</div>
            </li>
            <li>
              <a href="highSpikes.html">High Consumption Spikes</a>
              <div class="description">Baseline with EV charging/sauna spikes (14 days)</div>
            </li>
            <li>
              <a href="nightDiscount.html">Night Discount</a>
              <div class="description">Tests night discount (nattsÃ¤nkning) feature (7 days)</div>
            </li>
            <li>
              <a href="weekdaysOnly.html">Weekdays Only</a>
              <div class="description">Weekday-only limit enforcement like Ellevio (14 days)</div>
            </li>
            <li>
              <a href="winterSeason.html">Winter Season</a>
              <div class="description">Winter season filtering Nov-Mar (60 days)</div>
            </li>
            <li>
              <a href="singlePhase.html">Single Phase Installation</a>
              <div class="description">Single phase home configuration (7 days)</div>
            </li>
            <li>
              <a href="minimumLimit.html">Minimum Limit Enforcement</a>
              <div class="description">Very low consumption, minimum limit test (7 days)</div>
            </li>
            <li>
              <a href="jonkoping.html">JÃ¶nkÃ¶ping Energi Style</a>
              <div class="description">2 peaks, all year configuration (14 days)</div>
            </li>
            <li>
              <a href="stressTest.html">Stress Test</a>
              <div class="description">High variability consumption (30 days)</div>
            </li>
            <li>
              <a href="batteryCharging.html">Battery Charging</a>
              <div class="description">Smart battery charging during off-peak hours (7 days)</div>
            </li>
            <li>
              <a href="batteryBalancing.html">Battery Balancing</a>
              <div class="description">Periodic battery balancing feature (1 day)</div>
            </li>
            <li>
              <a href="dynamicHeadroom.html">Dynamic Headroom</a>
              <div class="description">Dynamic headroom based on battery SOC (1 day)</div>
            </li>
            <li>
              <a href="downtimeDetection.html">Downtime Detection</a>
              <div class="description">System downtime detection with data gaps (3 days)</div>
            </li>
          </ul>

          <p class="meta">Generated automatically by GitHub Actions.
            <a href="https://github.com/dirkjanfaber/node-red-contrib-effekttariff">View source on GitHub</a>
          </p>
        </body>
        </html>
        EOF

    - name: Commit and push reports
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add docs/simulations/
        git diff --staged --quiet || git commit -m "docs: Update simulation reports [skip ci]"
        git push
