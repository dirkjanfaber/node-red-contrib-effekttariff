<script type="text/javascript">
  RED.nodes.registerType('effekttariff', {
    category: 'Victron Energy',
    color: '#F7AB3E',
    defaults: {
      name: { value: '' },
      peakCount: { value: 3, validate: RED.validators.number() },
      onePeakPerDay: { value: true },
      peakHoursStart: { value: 7, validate: RED.validators.number() },
      peakHoursEnd: { value: 21, validate: RED.validators.number() },
      weekdaysOnly: { value: false },
      nightDiscount: { value: false },
      peakSeasonOnly: { value: true },
      peakSeasonStart: { value: 11, validate: RED.validators.number() },
      peakSeasonEnd: { value: 3, validate: RED.validators.number() },
      minimumLimit: { value: 4, validate: RED.validators.number() },
      headroom: { value: 0.3, validate: RED.validators.number() },
      phases: { value: 3, validate: RED.validators.number() },
      gridVoltage: { value: 230, validate: RED.validators.number() },
      maxBreakerCurrent: { value: 25, validate: RED.validators.number() },
      // Battery charging settings
      batteryEnabled: { value: false },
      socContextKey: { value: 'battery.soc' },
      minSocContextKey: { value: 'battery.minSoc' },
      batteryCapacity: { value: 10, validate: RED.validators.number() },
      maxChargeRate: { value: 3000, validate: RED.validators.number() },
      socBuffer: { value: 20, validate: RED.validators.number() },
      // Forecasting settings
      forecastSource: { value: 'none' },
      forecastContextKey: { value: 'forecast' },
      morningPeakStart: { value: 6, validate: RED.validators.number() },
      morningPeakEnd: { value: 9, validate: RED.validators.number() },
      morningPeakWeight: { value: 0.3, validate: RED.validators.number() },
      eveningPeakStart: { value: 17, validate: RED.validators.number() },
      eveningPeakEnd: { value: 21, validate: RED.validators.number() },
      eveningPeakWeight: { value: 1.0, validate: RED.validators.number() },
      budgetBuffer: { value: 20, validate: RED.validators.number() }
    },
    inputs: 1,
    outputs: 4,
    icon: 'font-awesome/fa-bolt',
    label: function () {
      return this.name || 'Effekttariff'
    },
    paletteLabel: 'Effekttariff',
    inputLabels: ['Grid Power (W)'],
    outputLabels: ['Current Limit (A)', 'Status', 'Charge Rate (W)', 'Chart Data'],
    oneditprepare: function () {
      // Season month dropdowns
      const months = [
        { value: 1, label: 'January' },
        { value: 2, label: 'February' },
        { value: 3, label: 'March' },
        { value: 4, label: 'April' },
        { value: 5, label: 'May' },
        { value: 6, label: 'June' },
        { value: 7, label: 'July' },
        { value: 8, label: 'August' },
        { value: 9, label: 'September' },
        { value: 10, label: 'October' },
        { value: 11, label: 'November' },
        { value: 12, label: 'December' }
      ]

      const $seasonStart = $('#node-input-peakSeasonStart')
      const $seasonEnd = $('#node-input-peakSeasonEnd')

      months.forEach(m => {
        $seasonStart.append($('<option>').val(m.value).text(m.label))
        $seasonEnd.append($('<option>').val(m.value).text(m.label))
      })

      $seasonStart.val(this.peakSeasonStart || 11)
      $seasonEnd.val(this.peakSeasonEnd || 3)

      // Toggle season fields visibility
      function toggleSeasonFields () {
        const show = $('#node-input-peakSeasonOnly').is(':checked')
        $('.season-row').toggle(show)
      }

      $('#node-input-peakSeasonOnly').on('change', toggleSeasonFields)
      toggleSeasonFields()

      // Toggle battery fields visibility
      function toggleBatteryFields () {
        const show = $('#node-input-batteryEnabled').is(':checked')
        $('.battery-row').toggle(show)
        // Also show/hide forecasting section based on battery
        toggleForecastFields()
      }

      $('#node-input-batteryEnabled').on('change', toggleBatteryFields)
      toggleBatteryFields()

      // Toggle forecast fields visibility based on source
      function toggleForecastFields () {
        const batteryEnabled = $('#node-input-batteryEnabled').is(':checked')
        const source = $('#node-input-forecastSource').val()

        // Show forecasting section only when battery is enabled
        $('.forecast-section').toggle(batteryEnabled)

        // Show time-based fields
        const showTimeBased = batteryEnabled && source === 'time-based'
        $('.forecast-timebased-row').toggle(showTimeBased)

        // Show external fields
        const showExternal = batteryEnabled && source === 'external'
        $('.forecast-external-row').toggle(showExternal)

        // Show budget fields for all sources except 'none'
        const showBudget = batteryEnabled && source !== 'none'
        $('.forecast-budget-row').toggle(showBudget)
      }

      $('#node-input-forecastSource').on('change', toggleForecastFields)
      toggleForecastFields()
    }
  })
</script>

<script type="text/html" data-template-name="effekttariff">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="effekttariff.label.name">Name</span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]effekttariff.placeholder.name">
  </div>

  <hr>
  <h4 data-i18n="effekttariff.section.peak">Peak Measurement</h4>

  <div class="form-row">
    <label for="node-input-peakCount"><i class="fa fa-list-ol"></i> <span data-i18n="effekttariff.label.peakCount">Peaks to average</span></label>
    <input type="number" id="node-input-peakCount" min="2" max="5" style="width:60px">
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-onePeakPerDay" style="width:auto; margin-right:5px">
    <label for="node-input-onePeakPerDay" style="width:auto" data-i18n="effekttariff.label.onePeakPerDay">One peak per day only</label>
  </div>

  <div class="form-row">
    <label for="node-input-peakHoursStart"><i class="fa fa-clock-o"></i> <span data-i18n="effekttariff.label.peakHours">Peak hours</span></label>
    <input type="number" id="node-input-peakHoursStart" min="0" max="23" style="width:60px">
    <span>-</span>
    <input type="number" id="node-input-peakHoursEnd" min="0" max="23" style="width:60px">
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-weekdaysOnly" style="width:auto; margin-right:5px">
    <label for="node-input-weekdaysOnly" style="width:auto" data-i18n="effekttariff.label.weekdaysOnly">Weekdays only</label>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-nightDiscount" style="width:auto; margin-right:5px">
    <label for="node-input-nightDiscount" style="width:auto" data-i18n="effekttariff.label.nightDiscount">Night discount 50% (22-06)</label>
  </div>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-peakSeasonOnly" style="width:auto; margin-right:5px">
    <label for="node-input-peakSeasonOnly" style="width:auto" data-i18n="effekttariff.label.peakSeasonOnly">Winter season only</label>
  </div>

  <div class="form-row season-row">
    <label for="node-input-peakSeasonStart"><i class="fa fa-calendar"></i> <span data-i18n="effekttariff.label.season">Season</span></label>
    <select id="node-input-peakSeasonStart" style="width:120px"></select>
    <span>-</span>
    <select id="node-input-peakSeasonEnd" style="width:120px"></select>
  </div>

  <hr>
  <h4 data-i18n="effekttariff.section.limits">Limits</h4>

  <div class="form-row">
    <label for="node-input-minimumLimit"><i class="fa fa-minus-circle"></i> <span data-i18n="effekttariff.label.minimumLimit">Minimum (kW)</span></label>
    <input type="number" id="node-input-minimumLimit" min="2" max="20" step="0.5" style="width:80px">
  </div>

  <div class="form-row">
    <label for="node-input-headroom"><i class="fa fa-arrows-v"></i> <span data-i18n="effekttariff.label.headroom">Headroom (kW)</span></label>
    <input type="number" id="node-input-headroom" min="0" max="2" step="0.1" style="width:80px">
  </div>

  <hr>
  <h4 data-i18n="effekttariff.section.electrical">Electrical</h4>

  <div class="form-row">
    <label for="node-input-phases"><i class="fa fa-plug"></i> <span data-i18n="effekttariff.label.phases">Phases</span></label>
    <input type="number" id="node-input-phases" min="1" max="3" style="width:60px">
  </div>

  <div class="form-row">
    <label for="node-input-gridVoltage"><i class="fa fa-bolt"></i> <span data-i18n="effekttariff.label.gridVoltage">Grid voltage (V)</span></label>
    <input type="number" id="node-input-gridVoltage" min="100" max="400" style="width:80px">
  </div>

  <div class="form-row">
    <label for="node-input-maxBreakerCurrent"><i class="fa fa-exclamation-triangle"></i> <span data-i18n="effekttariff.label.maxBreakerCurrent">Max breaker (A)</span></label>
    <input type="number" id="node-input-maxBreakerCurrent" min="10" max="63" style="width:80px">
  </div>

  <hr>
  <h4 data-i18n="effekttariff.section.battery">Battery Charging</h4>

  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-batteryEnabled" style="width:auto; margin-right:5px">
    <label for="node-input-batteryEnabled" style="width:auto" data-i18n="effekttariff.label.batteryEnabled">Enable battery charging</label>
  </div>

  <div class="form-row battery-row">
    <label for="node-input-socContextKey"><i class="fa fa-database"></i> <span data-i18n="effekttariff.label.socContextKey">SOC context key</span></label>
    <input type="text" id="node-input-socContextKey" style="width:200px" placeholder="battery.soc">
  </div>

  <div class="form-row battery-row">
    <label for="node-input-minSocContextKey"><i class="fa fa-database"></i> <span data-i18n="effekttariff.label.minSocContextKey">Min SOC context key</span></label>
    <input type="text" id="node-input-minSocContextKey" style="width:200px" placeholder="battery.minSoc">
  </div>

  <div class="form-row battery-row">
    <label for="node-input-batteryCapacity"><i class="fa fa-battery-full"></i> <span data-i18n="effekttariff.label.batteryCapacity">Capacity (kWh)</span></label>
    <input type="number" id="node-input-batteryCapacity" min="1" max="100" step="0.5" style="width:80px">
  </div>

  <div class="form-row battery-row">
    <label for="node-input-maxChargeRate"><i class="fa fa-bolt"></i> <span data-i18n="effekttariff.label.maxChargeRate">Max charge (W)</span></label>
    <input type="number" id="node-input-maxChargeRate" min="500" max="20000" step="100" style="width:100px">
  </div>

  <div class="form-row battery-row">
    <label for="node-input-socBuffer"><i class="fa fa-plus-circle"></i> <span data-i18n="effekttariff.label.socBuffer">SOC buffer (%)</span></label>
    <input type="number" id="node-input-socBuffer" min="5" max="50" style="width:80px">
  </div>

  <div class="forecast-section">
    <hr>
    <h4 data-i18n="effekttariff.section.forecasting">Consumption Forecasting</h4>

    <div class="form-row">
      <label for="node-input-forecastSource"><i class="fa fa-line-chart"></i> <span data-i18n="effekttariff.label.forecastSource">Forecast source</span></label>
      <select id="node-input-forecastSource" style="width:200px">
        <option value="none" data-i18n="effekttariff.option.forecastNone">None (reactive)</option>
        <option value="time-based" data-i18n="effekttariff.option.forecastTimeBased">Time-based patterns</option>
        <option value="historical" data-i18n="effekttariff.option.forecastHistorical">Historical learning</option>
        <option value="external" data-i18n="effekttariff.option.forecastExternal">External (VRM/API)</option>
      </select>
    </div>

    <div class="form-row forecast-external-row">
      <label for="node-input-forecastContextKey"><i class="fa fa-database"></i> <span data-i18n="effekttariff.label.forecastContextKey">Forecast context key</span></label>
      <input type="text" id="node-input-forecastContextKey" style="width:200px" placeholder="forecast">
    </div>

    <div class="form-row forecast-timebased-row">
      <label for="node-input-morningPeakStart"><i class="fa fa-sun-o"></i> <span data-i18n="effekttariff.label.morningPeak">Morning peak</span></label>
      <input type="number" id="node-input-morningPeakStart" min="0" max="12" style="width:60px">
      <span>-</span>
      <input type="number" id="node-input-morningPeakEnd" min="0" max="12" style="width:60px">
      <span style="margin-left:10px">Weight:</span>
      <input type="number" id="node-input-morningPeakWeight" min="0" max="1" step="0.1" style="width:60px">
    </div>

    <div class="form-row forecast-timebased-row">
      <label for="node-input-eveningPeakStart"><i class="fa fa-moon-o"></i> <span data-i18n="effekttariff.label.eveningPeak">Evening peak</span></label>
      <input type="number" id="node-input-eveningPeakStart" min="12" max="23" style="width:60px">
      <span>-</span>
      <input type="number" id="node-input-eveningPeakEnd" min="12" max="23" style="width:60px">
      <span style="margin-left:10px">Weight:</span>
      <input type="number" id="node-input-eveningPeakWeight" min="0" max="1" step="0.1" style="width:60px">
    </div>

    <div class="form-row forecast-budget-row">
      <label for="node-input-budgetBuffer"><i class="fa fa-shield"></i> <span data-i18n="effekttariff.label.budgetBuffer">Budget buffer (%)</span></label>
      <input type="number" id="node-input-budgetBuffer" min="0" max="50" style="width:80px">
      <span style="margin-left:10px; color:#666; font-size:11px" data-i18n="effekttariff.help.budgetBuffer">Reserve for unexpected peaks</span>
    </div>
  </div>
</script>

<script type="text/html" data-help-name="effekttariff">
  <p>Swedish effekttariff (power tariff) peak shaving controller with optional battery charging.</p>

  <h3>Input</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">number</span></dt>
    <dd>Grid power in Watts (positive = import from grid)</dd>
  </dl>

  <h3>Outputs</h3>
  <ol class="node-ports">
    <li>Current Limit
      <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>Target current limit in Amperes. Only outputs when value changes.</dd>
      </dl>
    </li>
    <li>Status
      <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Status object with peak data and battery status for debugging/dashboard</dd>
      </dl>
    </li>
    <li>Charge Rate (when battery enabled)
      <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>Recommended charge rate in Watts. Only outputs when value changes.</dd>
        <dt>charging <span class="property-type">boolean</span></dt>
        <dd>Whether charging is recommended</dd>
        <dt>reason <span class="property-type">string</span></dt>
        <dd>Explanation of charge decision</dd>
        <dt>details <span class="property-type">object</span></dt>
        <dd>Contains currentSoc, targetSoc, minSoc, hoursUntilPeak, energyDeficitWh</dd>
      </dl>
    </li>
    <li>Chart Data (for FlowFuse Dashboard)
      <dl class="message-properties">
        <dt>payload <span class="property-type">array</span></dt>
        <dd>Array of chart-ready messages for ui-chart node. Each message has topic (series name) and payload with x (timestamp) and y (value). Series: consumption, limit, target, peak_avg, battery_soc.</dd>
      </dl>
    </li>
  </ol>

  <h3>Details</h3>
  <p>The Swedish effekttariff charges based on the average of your 2-3 highest
  hourly consumption peaks during the month.</p>

  <p>This node:</p>
  <ul>
    <li>Tracks hourly average consumption</li>
    <li>Records top peaks for the month</li>
    <li>Outputs a current limit to keep new peaks below existing ones</li>
    <li>Resets automatically on the 1st of each month</li>
  </ul>

  <h4>Learning Phase</h4>
  <p>At the start of each month, the node enters a learning phase until it has
  recorded enough peaks. During learning, it outputs the minimum limit to
  prevent establishing unnecessarily high peaks.</p>

  <h4>Battery Charging</h4>
  <p>When battery charging is enabled, the node reads SOC from global context
  and calculates the optimal charge rate to ensure the battery is charged
  before peak hours begin.</p>

  <p>The charging algorithm:</p>
  <ul>
    <li>Target SOC = min SOC + buffer (e.g., 50% + 20% = 70%)</li>
    <li>Charges during off-peak hours only</li>
    <li>Calculates charge rate based on energy deficit and time until peak</li>
    <li>Respects maximum charge rate limit</li>
    <li>Outputs 0W during peak hours (discharge for peak shaving)</li>
  </ul>

  <h4>Consumption Forecasting</h4>
  <p>When battery is enabled, you can configure consumption forecasting to
  intelligently distribute battery capacity across expected peak periods.</p>

  <p><b>Forecast sources:</b></p>
  <ul>
    <li><b>None (reactive)</b>: Discharges battery fully on first peaks (default)</li>
    <li><b>Time-based patterns</b>: Uses configured morning/evening peak windows</li>
    <li><b>Historical learning</b>: Learns from previous days' consumption</li>
    <li><b>External (VRM/API)</b>: Accepts forecast via msg.forecast or context</li>
  </ul>

  <p><b>How it works:</b></p>
  <ul>
    <li>Forecasts expected peak periods for the day</li>
    <li>Allocates battery budget proportionally to expected peak heights</li>
    <li>Discharges partially during morning peaks to save capacity for evening</li>
    <li>Results in more balanced peak reduction across the day</li>
  </ul>

  <p><b>External forecast format (msg.forecast):</b></p>
  <pre>{ hourly: [500, 400, ..., 6000, ...] } // 24 hourly values in Watts</pre>

  <h4>Status Indicator</h4>
  <ul>
    <li><b>Grey ring</b>: Off-season</li>
    <li><b>Green ring</b>: Off-peak hours</li>
    <li><b>Blue ring</b>: Learning phase or charging</li>
    <li><b>Blue dot</b>: Peak hours, usage below target</li>
    <li><b>Yellow dot</b>: Approaching target (&gt;85%)</li>
    <li><b>Red dot</b>: Over target (&gt;105%)</li>
  </ul>
</script>
